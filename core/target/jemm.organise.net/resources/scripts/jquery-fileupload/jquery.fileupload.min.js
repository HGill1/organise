(function(a){if(typeof define==="function"&&define.amd){define(["jquery","jquery.ui.widget"],a)}else{a(window.jQuery)}}(function(a){a.support.xhrFileUpload=!!(window.XMLHttpRequestUpload&&window.FileReader);a.support.xhrFormDataFileUpload=!!window.FormData;a.widget("blueimp.fileupload",{options:{namespace:undefined,dropZone:a(document),fileInput:undefined,replaceFileInput:true,paramName:undefined,singleFileUploads:true,limitMultiFileUploads:undefined,sequentialUploads:false,limitConcurrentUploads:undefined,forceIframeTransport:false,redirect:undefined,redirectParamName:undefined,postMessage:undefined,multipart:true,maxChunkSize:undefined,uploadedBytes:undefined,recalculateProgress:true,progressInterval:100,bitrateInterval:500,formData:function(b){return b.serializeArray()},add:function(b,c){c.submit()},processData:false,contentType:false,cache:false},_refreshOptionsList:["namespace","dropZone","fileInput","multipart","forceIframeTransport"],_BitrateTimer:function(){this.timestamp=+(new Date());this.loaded=0;this.bitrate=0;this.getBitrate=function(b,e,d){var c=b-this.timestamp;if(!this.bitrate||!d||c>d){this.bitrate=(e-this.loaded)*(1000/c)*8;this.loaded=e;this.timestamp=b}return this.bitrate}},_isXHRUpload:function(b){return !b.forceIframeTransport&&((!b.multipart&&a.support.xhrFileUpload)||a.support.xhrFormDataFileUpload)},_getFormData:function(c){var b;if(typeof c.formData==="function"){return c.formData(c.form)}if(a.isArray(c.formData)){return c.formData}if(c.formData){b=[];a.each(c.formData,function(e,d){b.push({name:e,value:d})});return b}return[]},_getTotal:function(b){var c=0;a.each(b,function(e,d){c+=d.size||1});return c},_onProgress:function(c,g){if(c.lengthComputable){var b=+(new Date()),f,d;if(g._time&&g.progressInterval&&(b-g._time<g.progressInterval)&&c.loaded!==c.total){return}g._time=b;f=g.total||this._getTotal(g.files);d=parseInt(c.loaded/c.total*(g.chunkSize||f),10)+(g.uploadedBytes||0);this._loaded+=d-(g.loaded||g.uploadedBytes||0);g.lengthComputable=true;g.loaded=d;g.total=f;g.bitrate=g._bitrateTimer.getBitrate(b,d,g.bitrateInterval);this._trigger("progress",c,g);this._trigger("progressall",c,{lengthComputable:true,loaded:this._loaded,total:this._total,bitrate:this._bitrateTimer.getBitrate(b,this._loaded,g.bitrateInterval)})}},_initProgressListener:function(d){var b=this,c=d.xhr?d.xhr():a.ajaxSettings.xhr();if(c.upload){a(c.upload).bind("progress",function(f){var g=f.originalEvent;f.lengthComputable=g.lengthComputable;f.loaded=g.loaded;f.total=g.total;b._onProgress(f,d)});d.xhr=function(){return c}}},_initXHRData:function(f){var c,b=f.files[0],d=f.multipart||!a.support.xhrFileUpload,e=f.paramName[0];if(!d||f.blob){f.headers=a.extend(f.headers,{"X-File-Name":b.name,"X-File-Type":b.type,"X-File-Size":b.size});if(!f.blob){f.contentType=b.type;f.data=b}else{if(!d){f.contentType="application/octet-stream";f.data=f.blob}}}if(d&&a.support.xhrFormDataFileUpload){if(f.postMessage){c=this._getFormData(f);if(f.blob){c.push({name:e,value:f.blob})}else{a.each(f.files,function(h,g){c.push({name:f.paramName[h]||e,value:g})})}}else{if(f.formData instanceof FormData){c=f.formData}else{c=new FormData();a.each(this._getFormData(f),function(h,g){c.append(g.name,g.value)})}if(f.blob){c.append(e,f.blob,b.name)}else{a.each(f.files,function(h,g){if(g instanceof Blob){c.append(f.paramName[h]||e,g,g.name)}})}}f.data=c}f.blob=null},_initIframeSettings:function(b){b.dataType="iframe "+(b.dataType||"");b.formData=this._getFormData(b);if(b.redirect&&a("<a></a>").prop("href",b.url).prop("host")!==location.host){b.formData.push({name:b.redirectParamName||"redirect",value:b.redirect})}},_initDataSettings:function(b){if(this._isXHRUpload(b)){if(!this._chunkedUpload(b,true)){if(!b.data){this._initXHRData(b)}this._initProgressListener(b)}if(b.postMessage){b.dataType="postmessage "+(b.dataType||"")}}else{this._initIframeSettings(b,"iframe")}},_getParamName:function(d){var b=a(d.fileInput),c=d.paramName;if(!c){c=[];b.each(function(){var g=a(this),e=g.prop("name")||"files[]",f=(g.prop("files")||[1]).length;while(f){c.push(e);f-=1}});if(!c.length){c=[b.prop("name")||"files[]"]}}else{if(!a.isArray(c)){c=[c]}}return c},_initFormSettings:function(b){if(!b.form||!b.form.length){b.form=a(b.fileInput.prop("form"))}b.paramName=this._getParamName(b);if(!b.url){b.url=b.form.prop("action")||location.href}b.type=(b.type||b.form.prop("method")||"").toUpperCase();if(b.type!=="POST"&&b.type!=="PUT"){b.type="POST"}},_getAJAXSettings:function(c){var b=a.extend({},this.options,c);this._initFormSettings(b);this._initDataSettings(b);return b},_enhancePromise:function(b){b.success=b.done;b.error=b.fail;b.complete=b.always;return b},_getXHRPromise:function(b,c,d){var f=a.Deferred(),e=f.promise();c=c||this.options.context||e;if(b===true){f.resolveWith(c,d)}else{if(b===false){f.rejectWith(c,d)}}e.abort=f.promise;return this._enhancePromise(e)},_chunkedUpload:function(h,d){var i=this,f=h.files[0],g=f.size,b=h.uploadedBytes=h.uploadedBytes||0,l=h.maxChunkSize||g,c=f.webkitSlice||f.mozSlice||f.slice,j,k,m,e;if(!(this._isXHRUpload(h)&&c&&(b||l<g))||h.data){return false}if(d){return true}if(b>=g){f.error="uploadedBytes";return this._getXHRPromise(false,h.context,[null,"error",f.error])}k=Math.ceil((g-b)/l);j=function(n){if(!n){return i._getXHRPromise(true,h.context)}return j(n-=1).pipe(function(){var p=a.extend({},h);p.blob=c.call(f,b+n*l,b+(n+1)*l);p.chunkSize=p.blob.size;i._initXHRData(p);i._initProgressListener(p);m=(a.ajax(p)||i._getXHRPromise(false,p.context)).done(function(){if(!p.loaded){i._onProgress(a.Event("progress",{lengthComputable:true,loaded:p.chunkSize,total:p.chunkSize}),p)}h.uploadedBytes=p.uploadedBytes+=p.chunkSize});return m})};e=j(k);e.abort=function(){return m.abort()};return this._enhancePromise(e)},_beforeSend:function(b,c){if(this._active===0){this._trigger("start");this._bitrateTimer=new this._BitrateTimer()}this._active+=1;this._loaded+=c.uploadedBytes||0;this._total+=this._getTotal(c.files)},_onDone:function(d,c,e,b){if(!this._isXHRUpload(b)){this._onProgress(a.Event("progress",{lengthComputable:true,loaded:1,total:1}),b)}b.result=d;b.textStatus=c;b.jqXHR=e;this._trigger("done",null,b)},_onFail:function(e,d,c,b){b.jqXHR=e;b.textStatus=d;b.errorThrown=c;this._trigger("fail",null,b);if(b.recalculateProgress){this._loaded-=b.loaded||b.uploadedBytes||0;this._total-=b.total||this._getTotal(b.files)}},_onAlways:function(d,c,b,e){this._active-=1;e.textStatus=c;if(b&&b.always){e.jqXHR=b;e.result=d}else{e.jqXHR=d;e.errorThrown=b}this._trigger("always",null,e);if(this._active===0){this._trigger("stop");this._loaded=this._total=0;this._bitrateTimer=null}},_onSend:function(c,b){var g=this,j,f,i,d=g._getAJAXSettings(b),h=function(e,k){g._sending+=1;d._bitrateTimer=new g._BitrateTimer();j=j||((e!==false&&g._trigger("send",c,d)!==false&&(g._chunkedUpload(d)||a.ajax(d)))||g._getXHRPromise(false,d.context,k)).done(function(m,l,n){g._onDone(m,l,n,d)}).fail(function(n,m,l){g._onFail(n,m,l,d)}).always(function(o,n,m){g._sending-=1;g._onAlways(o,n,m,d);if(d.limitConcurrentUploads&&d.limitConcurrentUploads>g._sending){var l=g._slots.shift();while(l){if(!l.isRejected()){l.resolve();break}l=g._slots.shift()}}});return j};this._beforeSend(c,d);if(this.options.sequentialUploads||(this.options.limitConcurrentUploads&&this.options.limitConcurrentUploads<=this._sending)){if(this.options.limitConcurrentUploads>1){f=a.Deferred();this._slots.push(f);i=f.pipe(h)}else{i=(this._sequence=this._sequence.pipe(h,h))}i.abort=function(){var e=[undefined,"abort","abort"];if(!j){if(f){f.rejectWith(e)}return h(false,e)}return j.abort()};return this._enhancePromise(i)}return h()},_onAdd:function(g,f){var k=this,n=true,h=a.extend({},this.options,f),j=h.limitMultiFileUploads,d=this._getParamName(h),b,c,l,m;if(!(h.singleFileUploads||j)||!this._isXHRUpload(h)){l=[f.files];b=[d]}else{if(!h.singleFileUploads&&j){l=[];b=[];for(m=0;m<f.files.length;m+=j){l.push(f.files.slice(m,m+j));c=d.slice(m,m+j);if(!c.length){c=d}b.push(c)}}else{b=d}}f.originalFiles=f.files;a.each(l||f.files,function(i,e){var o=a.extend({},f);o.files=l?e:[e];o.paramName=b[i];o.submit=function(){o.jqXHR=this.jqXHR=(k._trigger("submit",g,this)!==false)&&k._onSend(g,this);return this.jqXHR};return(n=k._trigger("add",g,o))});return n},_normalizeFile:function(c,b){if(b.name===undefined&&b.size===undefined){b.name=b.fileName;b.size=b.fileSize}},_replaceFileInput:function(c){var b=c.clone(true);a("<form></form>").append(b)[0].reset();c.after(b).detach();a.cleanData(c.unbind("remove"));this.options.fileInput=this.options.fileInput.map(function(d,e){if(e===c[0]){return b[0]}return e});if(c[0]===this.element[0]){this.element=b}},_onChange:function(b){var c=b.data.fileupload,d={files:a.each(a.makeArray(b.target.files),c._normalizeFile),fileInput:a(b.target),form:a(b.target.form)};if(!d.files.length){d.files=[{name:b.target.value.replace(/^.*\\/,"")}]}if(c.options.replaceFileInput){c._replaceFileInput(d.fileInput)}if(c._trigger("change",b,d)===false||c._onAdd(b,d)===false){return false}},_onPaste:function(b){var c=b.data.fileupload,f=b.originalEvent.clipboardData,d=(f&&f.items)||[],g={files:[]};a.each(d,function(h,e){var i=e.getAsFile&&e.getAsFile();if(i){g.files.push(i)}});if(c._trigger("paste",b,g)===false||c._onAdd(b,g)===false){return false}},_onDrop:function(b){var c=b.data.fileupload,d=b.dataTransfer=b.originalEvent.dataTransfer,f={files:a.each(a.makeArray(d&&d.files),c._normalizeFile)};if(c._trigger("drop",b,f)===false||c._onAdd(b,f)===false){return false}b.preventDefault()},_onDragOver:function(b){var c=b.data.fileupload,d=b.dataTransfer=b.originalEvent.dataTransfer;if(c._trigger("dragover",b)===false){return false}if(d){d.dropEffect="copy"}b.preventDefault()},_initEventHandlers:function(){var b=this.options.namespace;if(this._isXHRUpload(this.options)){this.options.dropZone.bind("dragover."+b,{fileupload:this},this._onDragOver).bind("drop."+b,{fileupload:this},this._onDrop).bind("paste."+b,{fileupload:this},this._onPaste)}this.options.fileInput.bind("change."+b,{fileupload:this},this._onChange)},_destroyEventHandlers:function(){var b=this.options.namespace;this.options.dropZone.unbind("dragover."+b,this._onDragOver).unbind("drop."+b,this._onDrop).unbind("paste."+b,this._onPaste);this.options.fileInput.unbind("change."+b,this._onChange)},_setOption:function(c,d){var b=a.inArray(c,this._refreshOptionsList)!==-1;if(b){this._destroyEventHandlers()}a.Widget.prototype._setOption.call(this,c,d);if(b){this._initSpecialOptions();this._initEventHandlers()}},_initSpecialOptions:function(){var b=this.options;if(b.fileInput===undefined){b.fileInput=this.element.is("input:file")?this.element:this.element.find("input:file")}else{if(!(b.fileInput instanceof a)){b.fileInput=a(b.fileInput)}}if(!(b.dropZone instanceof a)){b.dropZone=a(b.dropZone)}},_create:function(){var b=this.options;a.extend(b,a(this.element[0].cloneNode(false)).data());b.namespace=b.namespace||this.widgetName;this._initSpecialOptions();this._slots=[];this._sequence=this._getXHRPromise(true);this._sending=this._active=this._loaded=this._total=0;this._initEventHandlers()},destroy:function(){this._destroyEventHandlers();a.Widget.prototype.destroy.call(this)},enable:function(){a.Widget.prototype.enable.call(this);this._initEventHandlers()},disable:function(){this._destroyEventHandlers();a.Widget.prototype.disable.call(this)},add:function(b){if(!b||this.options.disabled){return}b.files=a.each(a.makeArray(b.files),this._normalizeFile);this._onAdd(null,b)},send:function(b){if(b&&!this.options.disabled){b.files=a.each(a.makeArray(b.files),this._normalizeFile);if(b.files.length){return this._onSend(null,b)}}return this._getXHRPromise(false,b&&b.context)}})}));